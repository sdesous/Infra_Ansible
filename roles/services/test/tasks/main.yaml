- name: Debug
  debug:
    msg: "{{ ANSIBLE_PRIVATE_ROLE_VARS }}"

# - name: Create Wireguard user
#   ansible.builtin.user:
#     name: "{{ Wireguard_Username }}"
#     comment: "{{ Wireguard_Username }}"
#     uid: "{{ Wireguard_UID }}"
#     create_home: true
#     password: '!'
#     shell: "/sbin/nologin"
#     groups: "podman"
#     append: yes

# - name: Change Wireguard's home directory permissions
#   file:
#     path: "/home/{{ Wireguard_Username }}"
#     owner: "{{ Wireguard_Username }}"
#     group: "{{ Wireguard_Username }}"
#     mode: '0770'
#     state: directory

# - name: Copy backups
#   ansible.posix.synchronize:
#     src: "{{ Wireguard_Backup_PATH }}"
#     dest: "{{ Wireguard_PATH }}"
#     recursive: true
#   when: restore is truthy
#   ignore_errors: true

# - name: Change permissions of restored directories
#   command: find {{ Wireguard_PATH }} -type d -exec chown {{ Wireguard_Username }} {} \; -exec chgrp {{ Wireguard_Username }} {} \; -exec chmod 0770 {} \;
#   when: restore is truthy
#   ignore_errors: true

# - name: Change permissions of restored files
#   command: find {{ Wireguard_PATH }} -type f -exec chown {{ Wireguard_Username }} {} \; -exec chgrp {{ Wireguard_Username }} {} \; -exec chmod 0660 {} \;
#   when: restore is truthy
#   ignore_errors: true

# - name: Create Wireguard volume directory
#   file:
#     path: "{{ Wireguard_PATH }}"
#     owner: "{{ Wireguard_Username }}"
#     group: "{{ Wireguard_Username }}"
#     mode: '0770'
#     state: directory

# - name: Install slirp4netns
#   command: apk add slirp4netns

# - name: Run modprobe command
#   command: "modprobe {{ item }}"
#   with_items: ["ip_tables", "iptable_filter"]

# - name: Make modprobe persistent
#   ansible.builtin.lineinfile:
#     path: "/etc/modules"
#     line: "{{ item }}"
#   with_items: ["ip_tables", "iptable_filter"]

# - name: Add user to subuid and subgid
#   import_tasks: subuid_or_subgid.yaml
#   vars:
#     username: "{{ Wireguard_Username }}"

# - name: Run podman system migrate
#   command: "podman system migrate"
#   become: true
#   become_user: wireguard
#   become_method: su
#   become_flags: '-s /bin/ash'

# - name: Create Wireguard's pod
#   containers.podman.podman_pod:
#     name: wireguard_pod
#     state: started
#     ports: "{{ Wireguard_PORTS }}"
#   become: true
#   become_user: wireguard
#   become_method: su
#   become_flags: '-s /bin/ash'

# - name: Run Wireguard's container
#   containers.podman.podman_container:
#     pod: wireguard_pod
#     name: wireguard
#     image: "{{ link }}"
#     state: started
#     detach: yes
#     restart: true
#     volume: "{{ Wireguard_VOLUMES }}"
#     env: "{{ Wireguard_ENV }}"
#     restart_policy: always
#     capabilities:
#       - NET_ADMIN
#       - SYS_MODULE
#       - NET_RAW
#     sysctl:
#       {
#       net.ipv4.conf.all.src_valid_mark: 1,
#       net.ipv4.ip_forward: 1
#       }
#   become: true
#   become_user: wireguard
#   become_method: su
#   become_flags: '-s /bin/ash'

# - name: Create Wireguard yaml file
#   ansible.builtin.shell : "podman generate kube wireguard_pod > {{ Wireguard_PATH }}/wireguard_kubefile.yaml" 
#   become: true
#   become_user: wireguard
#   become_method: su
#   become_flags: '-s /bin/ash'

# - name: Rename the pod correctly in the yaml file
#   ansible.builtin.replace:
#     path: "{{ Wireguard_PATH }}/wireguard_kubefile.yaml"
#     regexp: 'wireguardpod'
#     replace: "wireguard_pod"

# - name: Change Wireguard's yaml file permissions
#   file:
#     path: "{{ Wireguard_PATH }}/wireguard_kubefile.yaml"
#     owner: root
#     group: "{{ Wireguard_Username }}"
#     mode: '0664'
#     state: file

# - name: Create pod file for init.d
#   ansible.builtin.copy:
#     dest: "/root/pods/{{ Wireguard_Username }}_service"
#     src: "{{ playbook_dir }}/resources/pod_template"
#     owner: root
#     group: root
#     mode: '0770'

# - name: Update {{ Wireguard_Username }}_service file
#   ansible.builtin.replace:
#     path: "/root/pods/{{ Wireguard_Username }}_service"
#     regexp: "{{ item.0 }}"
#     replace: "{{ item.1 }}"
#   with_together:
#     - ['\$user','\$volume_path','\$pod_name']
#     - ["{{ Wireguard_Username }}","{{ Wireguard_PATH }}","{{ Wireguard_Username }}_pod"]

# - name: Create Wireguard symlink
#   file:
#     src: "/root/pods/{{ Wireguard_Username }}_service"
#     dest: "/etc/init.d/wireguard"
#     state: link

# - name: Add Wireguard to init boot
#   command: "{{ item }}"
#   with_items:
#     - "rc-update add wireguard boot"